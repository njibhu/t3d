<html>
  <head>
    <title>cntc chunk analysis</title>
    <meta content="" />
    <style></style>
  </head>

  <body>
    <label>
      <input id="filePicker" type="file" />
    </label>
    <script src="./static/jquery.js"></script>
    <script src="./static/DataStream.js"></script>
    <script src="./static/T3D.js"></script>
    <script>
      var _lr;
      $("#filePicker").change(function (evt) {
        var file = evt.target.files[0];
        T3D.getLocalReader(
          file,
          async function (lr) {
            _lr = lr;
            res = await lr.readFileList();
            console.log("Sorting the files");

            //Get the cntc files
            let myFiles = res.filter((i) => {
              return i.fileType == "PF_cntc" && i.baseIdList[0] < 1000000;
            });

            let cntcTypes = {};

            console.log("Work:");
            let fileWork = 0;
            for (let elt of myFiles) {
              console.log((fileWork += 1));
              let r = await lr.readFile(elt.mftId);
              let file = new T3D.GW2File(new DataStream(r.buffer), 0);
              let mainChunk = file.getChunk("Main").data;

              for (let entry of mainChunk.indexEntries) {
                if (!cntcTypes[entry.type]) {
                  cntcTypes[entry.type] = {
                    amount: 0,
                    flagged: {},
                  };
                }

                cntcTypes[entry.type].amount += 1;
                cntcTypes[entry.type].flagged[elt.baseIdList[0]]
                  ? (cntcTypes[entry.type].flagged[elt.baseIdList[0]] += 1)
                  : (cntcTypes[entry.type].flagged[elt.baseIdList[0]] = 1);
              }
            }

            console.log(cntcTypes);
          },
          "./static/t3dworker.js"
        );
      });
    </script>
  </body>
</html>
